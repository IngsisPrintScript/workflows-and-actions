name: Publish Java Modules

on:
  workflow_call:
    inputs:
      java-version:
        type: string
        default: "21"
      environment:
        description: 'Deployment Environment'
        required: false
        default: 'development'
        type: string
      service_name:
        description: 'Service Name to deploy'
        required: false
        type: string
      image_route:
        description: 'Docker Image Route'
        required: false
        type: string

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    outputs:
      azure_rg: ${{ steps.set-deploy-vars.outputs.azure_rg }}
      azure_vm: ${{ steps.set-deploy-vars.outputs.azure_vm }}
      target_ip: ${{ steps.set-deploy-vars.outputs.target_ip }}
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ inputs.java-version }}

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Publish
        run: ./gradlew publish
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image (optional)
        if: ${{ always() }}
        run: |
          echo "Prepare Docker image push"
          IMAGE_TAG="${{ inputs.image_route }}"
          if [ -z "$IMAGE_TAG" ]; then
            IMAGE_TAG="ghcr.io/${{ github.repository_owner }}/${{ github.repository }}:${{ github.sha }}"
          fi
          echo "Image to push: $IMAGE_TAG"
          echo "Logging in to ghcr.io"
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          echo "Building image"
          docker build -t "$IMAGE_TAG" .
          echo "Pushing image"
          docker push "$IMAGE_TAG"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Azure Login (production)
        if: ${{ inputs.environment == 'production' }}
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_PROD }}

      - name: Azure Login (development)
        if: ${{ inputs.environment == 'development' }}
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_DEV }}
      - name: Debug secrets (build)
        if: ${{ always() }}
        run: |
          echo "Debugging secrets presence (build-and-publish)"
          if [ -z "${{ secrets.AZURE_CREDENTIALS_PROD }}" ]; then echo "AZURE_CREDENTIALS_PROD = NOT SET"; else echo "AZURE_CREDENTIALS_PROD = SET"; fi
          if [ -z "${{ secrets.AZURE_CREDENTIALS_DEV }}" ]; then echo "AZURE_CREDENTIALS_DEV = NOT SET"; else echo "AZURE_CREDENTIALS_DEV = SET"; fi
          if [ -z "${{ secrets.AZURE_RESOURCE_GROUP }}" ]; then echo "AZURE_RESOURCE_GROUP = NOT SET"; else echo "AZURE_RESOURCE_GROUP = SET"; fi
          if [ -z "${{ secrets.AZURE_VM_NAME_PROD }}" ]; then echo "AZURE_VM_NAME_PROD = NOT SET"; else echo "AZURE_VM_NAME_PROD = SET"; fi
          if [ -z "${{ secrets.AZURE_VM_NAME_DEV }}" ]; then echo "AZURE_VM_NAME_DEV = NOT SET"; else echo "AZURE_VM_NAME_DEV = SET"; fi
          if [ -z "${{ secrets.IP_PROD }}" ]; then echo "IP_PROD = NOT SET"; else echo "IP_PROD = SET"; fi
          if [ -z "${{ secrets.IP_DEV }}" ]; then echo "IP_DEV = NOT SET"; else echo "IP_DEV = SET"; fi
          if [ -n "${{ secrets.IP_PROD }}" ]; then ip="${{ secrets.IP_PROD }}"; echo "IP_PROD masked: ${ip%.*}.*"; fi
          if [ -n "${{ secrets.IP_DEV }}" ]; then ip="${{ secrets.IP_DEV }}"; echo "IP_DEV masked: ${ip%.*}.*"; fi
            
      - name: Set deploy variables (prod/dev)
        id: set-deploy-vars
        run: |
          if [ "${{ inputs.environment }}" = "production" ]; then
            echo "azure_rg=${{ secrets.AZURE_RESOURCE_GROUP }}" >> $GITHUB_OUTPUT
            echo "azure_vm=${{ secrets.AZURE_VM_NAME_PROD }}" >> $GITHUB_OUTPUT
            echo "target_ip=${{ secrets.IP_PROD }}" >> $GITHUB_OUTPUT
          else
            echo "azure_rg=${{ secrets.AZURE_RESOURCE_GROUP }}" >> $GITHUB_OUTPUT
            echo "azure_vm=${{ secrets.AZURE_VM_NAME_DEV }}" >> $GITHUB_OUTPUT
            echo "target_ip=${{ secrets.IP_DEV }}" >> $GITHUB_OUTPUT
          fi
      - name: Encender la Máquina Virtual
        run: |
          az vm start --resource-group "${{ steps.set-deploy-vars.outputs.azure_rg }}" --name "${{ steps.set-deploy-vars.outputs.azure_vm }}" || true

  deployment:
    name: Deploy to VM
    runs-on: ubuntu-latest
    needs: build-and-publish

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Debug secrets (deploy)
        if: ${{ always() }}
        run: |
          echo "Debugging secrets presence (deployment)"
          if [ -z "${{ secrets.PRIVATE_KEY_PROD }}" ]; then echo "PRIVATE_KEY_PROD = NOT SET"; else echo "PRIVATE_KEY_PROD = SET"; fi
          if [ -z "${{ secrets.PRIVATE_KEY_DEV }}" ]; then echo "PRIVATE_KEY_DEV = NOT SET"; else echo "PRIVATE_KEY_DEV = SET"; fi
          if [ -z "${{ secrets.USER }}" ]; then echo "USER = NOT SET"; else echo "USER = SET"; fi
          if [ -z "${{ secrets.GITHUB_TOKEN }}" ]; then echo "GITHUB_TOKEN = NOT SET"; else echo "GITHUB_TOKEN = SET"; fi
          if [ -n "${{ needs.build-and-publish.outputs.target_ip }}" ]; then ip="${{ needs.build-and-publish.outputs.target_ip }}"; echo "target_ip masked: ${ip%.*}.*"; fi
      - name: Add SSH key (production)
        if: ${{ inputs.environment == 'production' }}
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.PRIVATE_KEY_PROD }}

      - name: Add SSH key (development)
        if: ${{ inputs.environment != 'production' }}
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.PRIVATE_KEY_DEV }}

      - name: Deploy service (dev/prod)
        env:
          TARGET_IP: ${{ needs.build-and-publish.outputs.target_ip }}
          ENVIRONMENT: ${{ inputs.environment }}
        run: |
          if [ -z "${{ inputs.service_name }}" ]; then
            echo "inputs.service_name not provided — skipping deploy job."
            exit 0
          fi

          echo "Debug: needs.build-and-publish.outputs.target_ip='${{ needs.build-and-publish.outputs.target_ip }}'"
          echo "Debug: env TARGET_IP='$TARGET_IP'"

          if [ -z "$TARGET_IP" ]; then
            echo "TARGET_IP empty — falling back to secrets based on environment"
            if [ "${ENVIRONMENT}" = "production" ]; then
              TARGET_IP="${{ secrets.IP_PROD }}"
            else
              TARGET_IP="${{ secrets.IP_DEV }}"
            fi
            echo "Fallback used (masked): ${TARGET_IP%.*}.*"
          fi

          IP_ADDRESS="$TARGET_IP"

          echo "Target IP (masked): ${IP_ADDRESS%.*}.*"

          echo "Waiting for the VM to enable the port 22..."
          for i in {1..30}; do
            if nc -z $IP_ADDRESS 22; then
              echo "SSH available"
              break
            fi
            echo "Retry SSH attempt $i"
            sleep 5
          done

          echo "connecting by SSH"

          SERVICE_NAME="${{ inputs.service_name }}"
          # choose compose file locally so the remote command is simple
          COMPOSE_FILE="docker-compose.dev.yml"
          if [ "${ENVIRONMENT}" = "production" ]; then
            COMPOSE_FILE="docker-compose.prod.yml"
          fi

          
          echo "SSH command: ssh -o StrictHostKeyChecking=no ${{ secrets.USER }}@$IP_ADDRESS"
          ssh -o StrictHostKeyChecking=no ${{ secrets.USER }}@$IP_ADDRESS <<EOF
            set -e
            echo "Entering infra directory"
            cd infra-ingsis || exit 1
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            if [ -n "${{ inputs.image_route }}" ]; then
              docker pull ${{ inputs.image_route }}
            fi
            docker compose -f ${COMPOSE_FILE} up -d ${SERVICE_NAME}
          EOF

