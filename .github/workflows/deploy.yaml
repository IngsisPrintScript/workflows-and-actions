name: Publish Java Modules

on:
  workflow_call:
    inputs:
      java-version:
        type: string
        default: "21"
      environment:
        description: 'Deployment Environment'
        required: false
        default: 'development'
        type: string
      service_name:
        description: 'Service Name to deploy'
        required: false
        type: string
      image_route:
        description: 'Docker Image Route'
        required: false
        type: string

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    outputs:
      azure_rg: ${{ steps.set-deploy-vars.outputs.azure_rg }}
      azure_vm: ${{ steps.set-deploy-vars.outputs.azure_vm }}
      target_ip: ${{ steps.set-deploy-vars.outputs.target_ip }}
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ inputs.java-version }}

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Publish (debug)
        run: |
          echo "Running gradle publish with debug flags"
          ./gradlew --no-daemon publish --info --stacktrace
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        if: ${{ always() }}
        run: |
          echo "Prepare Docker image push"
          IMAGE_TAG="${{ inputs.image_route }}"
          if [ -z "$IMAGE_TAG" ]; then
            IMAGE_TAG="ghcr.io/${{ github.repository_owner }}/${{ github.repository }}:${{ github.sha }}"
          fi
          echo "Image to push: $IMAGE_TAG"
          echo "Logging in to ghcr.io"
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          echo "Building image"
          docker build \
            --build-arg GITHUB_USER=${{ github.actor }} \
            --build-arg GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }} \
            -t "$IMAGE_TAG" .
          echo "Pushing image"
          docker push "$IMAGE_TAG"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Azure Login (production)
        if: ${{ inputs.environment == 'production' }}
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_PROD }}

      - name: Azure Login (development)
        if: ${{ inputs.environment == 'development' }}
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_DEV }}

      - name: Set deploy variables (prod/dev)
        id: set-deploy-vars
        run: |
          if [ "${{ inputs.environment }}" = "production" ]; then
            echo "azure_rg=${{ secrets.AZURE_RESOURCE_GROUP }}" >> $GITHUB_OUTPUT
            echo "azure_vm=${{ secrets.AZURE_VM_NAME_PROD }}" >> $GITHUB_OUTPUT
            echo "target_ip=${{ secrets.IP_PROD }}" >> $GITHUB_OUTPUT
          else
            echo "azure_rg=${{ secrets.AZURE_RESOURCE_GROUP }}" >> $GITHUB_OUTPUT
            echo "azure_vm=${{ secrets.AZURE_VM_NAME_DEV }}" >> $GITHUB_OUTPUT
            echo "target_ip=${{ secrets.IP_DEV }}" >> $GITHUB_OUTPUT
          fi

      - name: Encender la Máquina Virtual
        run: |
          az vm start --resource-group "${{ steps.set-deploy-vars.outputs.azure_rg }}" --name "${{ steps.set-deploy-vars.outputs.azure_vm }}" || true

  deployment:
    name: Deploy to VM
    runs-on: ubuntu-latest
    needs: build-and-publish

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Add SSH key (production)
        if: ${{ inputs.environment == 'production' }}
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.PRIVATE_KEY_PROD }}

      - name: Add SSH key (development)
        if: ${{ inputs.environment != 'production' }}
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.PRIVATE_KEY_DEV }}

      - name: Deploy service (dev/prod)
        env:
          TARGET_IP: ${{ needs.build-and-publish.outputs.target_ip }}
          ENVIRONMENT: ${{ inputs.environment }}
        run: |
          if [ -z "${{ inputs.service_name }}" ]; then
            echo "inputs.service_name not provided — skipping deploy job."
            exit 0
          fi

          if [ -z "$TARGET_IP" ]; then
            if [ "${ENVIRONMENT}" = "production" ]; then
              TARGET_IP="${{ secrets.IP_PROD }}"
            else
              TARGET_IP="${{ secrets.IP_DEV }}"
            fi
          fi

          IP_ADDRESS="$TARGET_IP"

          echo "Waiting for the VM to enable the port 22..."
          for i in {1..30}; do
            if nc -z $IP_ADDRESS 22; then
              echo "SSH available"
              break
            fi
            echo "Retry SSH attempt $i"
            sleep 5
          done

          echo "connecting by SSH"

          SERVICE_NAME="${{ inputs.service_name }}"
          # choose compose file locally so the remote command is simple
          COMPOSE_FILE="docker-compose.dev.yml"
          if [ "${ENVIRONMENT}" = "production" ]; then
            COMPOSE_FILE="docker-compose.prod.yml"
          fi

          
          ssh -o StrictHostKeyChecking=no ${{ secrets.USER }}@$IP_ADDRESS <<EOF
            set -e
            echo "Entering infra directory"
            cd infra-ingsis || exit 1
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            if [ -n "${{ inputs.image_route }}" ]; then
              docker pull ${{ inputs.image_route }}
            fi
            docker compose -f ${COMPOSE_FILE} up -d ${SERVICE_NAME}
          EOF

