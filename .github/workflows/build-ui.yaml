name: Build & Deploy UI

on:
  workflow_call:
    inputs:
      environment:
        description: "deployment environment (development | production)"
        required: true
        type: string
      service_name:
        description: "docker-compose service name"
        required: true
        type: string
      image_route:
        description: "full image name (ghcr.io/...)"
        required: true
        type: string
    secrets:
      IP_DEV:
        required: true
      IP_PROD:
        required: true
      PRIVATE_KEY_DEV:
        required: true
      PRIVATE_KEY_PROD:
        required: true
      SSH_USER:
        required: true
      GHCR_USER:
        required: true
      GHCR_TOKEN:
        required: true

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      target_ip: ${{ steps.set-deploy-vars.outputs.target_ip }}
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to GHCR (runner)
        run: |
          echo "${{ secrets.GHCR_TOKEN }}" | \
            docker login ghcr.io -u ${{ secrets.GHCR_USER }} --password-stdin

      - name: Build UI Docker image
        run: |
          docker build -t ${{ inputs.image_route }} .

      - name: Push UI Docker image
        run: |
          docker push ${{ inputs.image_route }}

      - name: Set deploy variables (dev / prod)
        id: set-deploy-vars
        run: |
          if [ "${{ inputs.environment }}" = "production" ]; then
            echo "target_ip=${{ secrets.IP_PROD }}" >> "$GITHUB_OUTPUT"
          else
            echo "target_ip=${{ secrets.IP_DEV }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Debug target IP
        run: |
          echo "Resolved TARGET_IP=${{ steps.set-deploy-vars.outputs.target_ip }}"

  deployment:
    name: Deploy UI to VM
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Add SSH key (production)
        if: ${{ inputs.environment == 'production' }}
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.PRIVATE_KEY_PROD }}

      - name: Add SSH key (development)
        if: ${{ inputs.environment != 'production' }}
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.PRIVATE_KEY_DEV }}

      - name: Deploy UI
        env:
          TARGET_IP: ${{ needs.build-and-push.outputs.target_ip }}
          ENVIRONMENT: ${{ inputs.environment }}
        run: |
          if [ -z "$TARGET_IP" ]; then
            echo "‚ùå TARGET_IP is empty"
            exit 1
          fi

          COMPOSE_FILE="docker-compose.dev.yml"
          if [ "$ENVIRONMENT" = "production" ]; then
            COMPOSE_FILE="docker-compose.prod.yml"
          fi

          echo "Deploying to $TARGET_IP using $COMPOSE_FILE"

          ssh -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@$TARGET_IP <<EOF
              set -e
              cd infra-ingsis
              echo "${{ secrets.GHCR_TOKEN }}" | \
                docker login ghcr.io -u ${{ secrets.GHCR_USER }} --password-stdin
              docker pull ${{ inputs.image_route }}
              docker compose -f ${COMPOSE_FILE} up -d ${{ inputs.service_name }}
          EOF
